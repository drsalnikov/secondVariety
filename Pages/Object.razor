@page "/objects/{Kod:int}"

@using Microsoft.EntityFrameworkCore
@using SecondVariety.Models;
@using SecondVariety.Data;

@inject db1Context db1Context

<RadzenTemplateForm Data="@myObj" Submit="@((MyObject args) => { Submit(args); })">
  <div class="row gap-3">
    <div class="col-lg-12">
      <RadzenFieldset Text="Информация об объекте">
        <div class="row">
          <div class="col align-items-center">
            <RadzenLabel Text="Наименование:" />
            <RadzenTextBox @bind-Value=@myObj.Name />
          </div>
          <div class="col align-items-center">
            <RadzenLabel Text="Код:" />
            <RadzenNumeric TValue="int" @bind-Value=@myObj.Kod />
          </div>
        </div>
        <div class="row">
          <div class="col align-items-center">
            <RadzenLabel Text="Дата последнего ТО:" />
            <RadzenDatePicker @bind-Value=@myObj.LastTo DateFormat="d" />
          </div>
          <div class="col align-items-center">
            <RadzenLabel Text="Дата следующего ТО:" />
            <RadzenDatePicker @bind-Value=@myObj.LastTo DateFormat="d" />
          </div>
        </div>
        <div class="row">
          <div class="col align-items-center">
            <RadzenLabel Text="Межремонтный интервал (дни):" />
            <RadzenNumeric TValue="float" @bind-Value=@myObj.ToTime />
          </div>
          <div class="col align-items-center">
            <RadzenLabel Text="Межремонтный интервал (моточасы):" />
            <RadzenNumeric TValue="float" @bind-Value=@myObj.ToNar />
          </div>
        </div>
      </RadzenFieldset>
    </div>
  </div>
  <div class="row gap-3">
    <div class="col-lg-12">
      <RadzenFieldset Text="Наработка">
        <div class="row">
          <div class="col align-items-center">
            <RadzenLabel Text="Начальная дата:" />
            <RadzenDatePicker TValue="DateOnly" @bind-Value=@myObj.DateFrom />
          </div>
          <div class="col align-items-center">
            <RadzenLabel Text="Начальное значение наработки:" />
            <RadzenNumeric TValue="float" @bind-Value=@myObj.NarFrom />
          </div>
        </div>
        <div class="row">
          <div class="col align-items-center">
            <RadzenLabel Text="Планируемая наработка в год:" />
          </div>
          <div class="col align-items-center">
            <RadzenNumeric TValue="float" @bind-Value=@myObj.PlanYear />
          </div>
        </div>
        <div class="row">
          <div class="col align-items-center">
            <RadzenLabel Text="Текущая наработка:" />
            <RadzenNumeric TValue="float" @bind-Value=@myObj.TekNar />
          </div>
          <div class="col align-items-center">
            <RadzenLabel Text="Среднедневная наработка:" />
            <RadzenNumeric TValue="float" @bind-Value=@myObj.SredNar />
          </div>
        </div>
        <div class="row">
          <div class="col align-items-center">
            <RadzenLabel Text="Коэфициент изменения веса дня:" />
            <RadzenNumeric TValue="float" @bind-Value=@myObj.Koef1 />
          </div>
          <div class="col align-items-center">
            <RadzenLabel Text="Коэфициент веса средней наработки:" />
            <RadzenNumeric TValue="float" @bind-Value=@myObj.Koef2 />
          </div>
        </div>
      </RadzenFieldset>
    </div>
  </div>
  <div class="row gap-3">
    <div class="col-lg-12">
      <RadzenFieldset Text="Заявки">
        <RadzenDataGrid 
          AllowFiltering="true" 
          AllowColumnResize="true" 
          FilterMode="FilterMode.Advanced" 
          FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
          AllowSorting="true" 
          PageSize="10" 
          AllowPaging="true" 
          PagerHorizontalAlign="HorizontalAlign.Left" 
          SelectionMode="DataGridSelectionMode.Single"
          ShowPagingSummary="true"
          Data="@requests" 
          TItem="Request" 
          ColumnWidth="480px" 
          LogicalFilterOperator="LogicalFilterOperator.Or"
          IsLoading="@isLoading"
          Count="@countRequests"
          LoadData="@LoadData"
          >
          <Columns>
              <RadzenDataGridColumn TItem="Request" Property="Num" Title="Номер" Width="75px" TextAlign="TextAlign.Center" />
              <RadzenDataGridColumn TItem="Request" Property="Data" Title="Дата" FormatString="{0:d}" Width="150px" />
              <RadzenDataGridColumn TItem="Request" Property="DateFrom" Title="Дата начала работ"  FormatString="{0:d}" Width="150px"/>
              <RadzenDataGridColumn TItem="Request" Property="DateTo" Title="Дата окончания работ"  FormatString="{0:d}" Width="150px"/>
              <RadzenDataGridColumn TItem="Request" Property="Status" Title="Статус" Width="75px" />
          </Columns>
        </RadzenDataGrid>
      </RadzenFieldset>
    </div>
  </div>
  <div class="row gap-3">
    <div class="col-lg-12">
      <RadzenFieldset Text="Наработка">
        <RadzenDataGrid 
          AllowFiltering="true" 
          AllowColumnResize="true" 
          FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
          AllowSorting="true" 
          PageSize="10" 
          AllowPaging="true" 
          PagerHorizontalAlign="HorizontalAlign.Left" 
          SelectionMode="DataGridSelectionMode.Single"
          ShowPagingSummary="true"
          Data="@narabotki" 
          TItem="Narabotka" 
          ColumnWidth="480px" 
          IsLoading="@isLoading"
          LoadData="@LoadData"
          >
          <Columns>
              <RadzenDataGridColumn TItem="Narabotka" Property="Data" Title="Дата наработки" FormatString="{0:d}" Width="150px" />
              <RadzenDataGridColumn TItem="Narabotka" Property="Val" Title="Значение наработки" Width="150px"/>
          </Columns>
        </RadzenDataGrid>
      </RadzenFieldset>
    </div>
  </div>
</RadzenTemplateForm>

<EventConsole @ref=@console Class="mt-4" />

@code {
  [Parameter]
  public int Kod { get; set; }

  EventConsole console;

  private IEnumerable<Request> requests = Enumerable.Empty<Request>();
  private IEnumerable<Narabotka> narabotki = Enumerable.Empty<Narabotka>();
  private MyObject myObj = new MyObject();
  private SecondVariety.Models.Object? obj { get; set; }
  private bool isLoading;
  private int countRequests;
  private int countNarabotka;


  protected override async Task OnInitializedAsync()
  {
    await base.OnInitializedAsync();
    await LoadData();
  }

  async Task LoadData()
  {
    isLoading = true;
    await Task.Yield();

    obj = db1Context.Objects.FirstOrDefault(o => o.Kod == Kod);
    if (obj != null)
    {
      myObj = new MyObject(obj);
    }
    requests = db1Context.Requests.Where(o => o.KodObject == Kod).AsEnumerable();
    countRequests = requests.Count();
    narabotki = db1Context.Narabotkas.Where(o => o.KodObject == Kod).AsEnumerable();
    countNarabotka = narabotki.Count();
    isLoading = false;

  }

  void Submit(MyObject arg)
  {
      console.Log(arg);
  }

}